define(["jquery","knockout","pubsub","notifications","notifier","CCi18n","ccConstants","spinner","placeholderPatch","navigation","pageLayout/product","ccRestClient","pageLayout/site","bstypeahead"],function(e,t,n,r,s,o,u,a,f,l,c,h,p){"use strict";var d;return{WIDGET_ID:"quickOrder",rowsToAddToCart:t.observableArray(),activeSearchBoxIndex:t.observable(),skuList:t.observableArray(),interceptedLink:t.observable(null),isDirty:t.observable(!1),isModalVisible:t.observable(!1),popupId:"",disableAddToCartButton:t.observable(!1),skuIds:[],lines:[],invalidSKUs:[],newProducts:[],fileToUpload:t.observable(null),spinnerOptions:{parent:"#quick-order-body",posTop:"30%",posLeft:"20%"},MIN_CHARACTERS:2,locale:"",MAX_RESULTS:5,LEFT_MARGIN:10,MAX_ITEMS_PER_BATCH:50,beforeAppear:function(){var e=this;e.rowsToAddToCart.removeAll(),e.skuList.removeAll();for(var t=0;t<e.noOfRowsToDisplay();t++)e.createNewRow()},handleQuickViewClick:function(n,r,i){var s=r,o,a,f,l,p={};s&&(o=e(n),a=t.dataFor(o[0]),f=a.widgets()[0],h.request(u.ENDPOINT_PRODUCTS_GET_PRODUCT,p,function(e){var n=new c(e,{});f.product(n),f.variantOptionsArray([]),l=n.productVariantOptions?t.mapping.toJS(n.productVariantOptions()):null,f.productVariantOptions(l);var r=[];r.push({id:e.type});var i=[];if(l!==null)for(var s=0;s<l.length;s++)i.push({id:l[s].optionId,values:Object.keys(l[s].optionValueMap)});r[0].variants=i,f.productTypes(r),f.beforeAppear(),o.modal("show")},function(e){console.log(e)},i))},onLoad:function(r){var i=t.observable(null);r.locale=h.getStoredValue(u.LOCAL_STORAGE_USER_CONTENT_LOCALE),r.locale!=null?r.locale=JSON.parse(r.locale)[0].name:r.locale=e(":root").attr("lang");if(r.locale=="zh_CN"||r.locale=="zh_TW")r.MIN_CHARACTERS=1;e.Topic(n.topicNames.ADD_TO_QUICK_ORDER).subscribe(r.addToQuickOrder.bind(r)),r.handleUnsavedChanges=function(e,t){var n=t&&t.usingCCLink;if(!n&&!l.isPathEqualTo(r.links().profile.route))return r.removeEventHandlersForAnchorClick(),!0;if(r.user().loggedIn()){i=this.id;if(i==="CC-header-cart-total")return!0;r.interceptedLink=e.currentTarget.pathname;if(r.isDirty())return r.showModal(),n&&(t.preventDefault=!0),!1}},r.showModal=function(){e("#CC-quickOrder-modal").modal("show"),r.isModalVisible(!0)},r.navigateAway=function(){if(i==="CC-header-checkout"||i==="CC-loginHeader-logout"||i==="CC-customerAccount-view-orders"||i==="CC-header-language-link"||i.indexOf("CC-header-languagePicker")!=-1){r.removeEventHandlersForAnchorClick();var t=e("#"+i).get()[0];t.click()}else if(i==="CC-loginHeader-myAccount"){var t=e("#"+i).get()[0];t.click()}else l.isPathEqualTo(r.interceptedLink)||(l.goTo(r.interceptedLink),r.removeEventHandlersForAnchorClick())},r.handleModalCancelUpdateDiscard=function(){e("#CC-quickOrder-modal").modal("hide"),r.navigateAway()},r.addEventHandlersForAnchorClickSetPopupId=function(t){r.popupId=t,e("body").on("click.cc.unsaved","a",r.handleUnsavedChanges)},r.removeEventHandlersForAnchorClick=function(){e("body").off("click.cc.unsaved","a",r.handleUnsavedChanges)},r.navigateAway=function(){if(i==="CC-header-checkout"||i==="CC-loginHeader-logout"||i==="CC-customerAccount-view-orders"||i==="CC-header-language-link"||i.indexOf("CC-header-languagePicker")!=-1){r.removeEventHandlersForAnchorClick();var t=e("#"+i).get()[0];t.click()}else if(i==="CC-loginHeader-myAccount"){var t=e("#"+i).get()[0];t.click()}else l.isPathEqualTo(r.interceptedLink)||(l.goTo(r.interceptedLink),r.removeEventHandlersForAnchorClick());r.isDirty(!1)},r.hideModal=function(){if(r.isModalVisible()||r.user().isSearchInitiatedWithUnsavedChanges())e("#CC-quickOrder-modal").modal("hide"),e("body").removeClass("modal-open"),e(".modal-backdrop").remove()}},addToCart:function(){var e=this,t,n=[];s.clearError("quickOrderWidget"),e.disableAddToCartButton(!0),e.newProducts=[];var r;for(var i=0;i<e.rowsToAddToCart().length;i++){if(!e.rowsToAddToCart()[i].productQuantity.isValid()||e.rowsToAddToCart()[i].errorMessage()!==""){s.sendError("quickOrderWidget",e.translate("invalidInputs"),!0),e.disableAddToCartButton(!1);return}if(e.rowsToAddToCart()[i].productDisplay()==="")continue;e.rowsToAddToCart()[i].productDisplay()!==e.rowsToAddToCart()[i].productName()+"    "+e.rowsToAddToCart()[i].catRefId?(e.rowsToAddToCart()[i].errorMessage(""),e.rowsToAddToCart()[i].catRefId=e.rowsToAddToCart()[i].productDisplay(),e.skuList()[i]=e.rowsToAddToCart()[i].productDisplay(),r=e.newProducts.map(function(e){return e.catRefId}).indexOf(e.rowsToAddToCart()[i].catRefId),r>-1?e.newProducts[r].orderQuantity=parseInt(e.newProducts[r].orderQuantity)+parseInt(e.rowsToAddToCart()[i].productQuantity()):e.newProducts.push({orderQuantity:e.rowsToAddToCart()[i].productQuantity(),catRefId:e.rowsToAddToCart()[i].catRefId})):(r=e.newProducts.map(function(e){return e.catRefId}).indexOf(e.rowsToAddToCart()[i].catRefId),r>-1?e.newProducts[r].orderQuantity=parseInt(e.newProducts[r].orderQuantity)+parseInt(e.rowsToAddToCart()[i].productQuantity()):e.newProducts.push({orderQuantity:e.rowsToAddToCart()[i].productQuantity(),catRefId:e.rowsToAddToCart()[i].catRefId}))}e.newProducts.length>=1&&(e.cart().mergeCart(!0),e.total=e.newProducts.length,t=e.total-e.MAX_ITEMS_PER_BATCH,t<0&&(t=0),n=e.newProducts.slice(t,e.total),e.methodAddToCart(n))},methodAddToCart:function(e){var t=this,n,r,i=function(i){t.isDirty(!1),t.disableAddToCartButton(!1);for(var s=0;s<i.length;s++){r=t.skuList.indexOf(i[s].catalogRefId);while(r>-1)t.rowsToAddToCart.splice(r,1),t.skuList.splice(r,1),t.createNewRow(),r=t.skuList.indexOf(i[s].catalogRefId)}t.total>0&&t.total-t.MAX_ITEMS_PER_BATCH>0?(t.total=t.total-t.MAX_ITEMS_PER_BATCH,n=t.total-t.MAX_ITEMS_PER_BATCH,n<0&&(n=0),e=t.newProducts.slice(n,t.total),t.methodAddToCart(e)):(t.disableAddToCartButton(!1),a.destroyWithoutDelay(t.spinnerOptions.parent))},u=function(e){t.isDirty(!1),t.disableAddToCartButton(!1);var n="",r;for(var i=0;i<e.length;i++){n=n+"\r\n"+e[i].errorMessage;if(e[i].catRefId){var u=e[i].catRefId.split(",");for(var a=0;a<u.length;a++){var f=t.skuList.indexOf(u[a]);f>-1&&(e[i].errorCode==="28129"?t.rowsToAddToCart()[f].errorMessage(o.t("ns.quickOrder:resources.noLongerForSaleText")):e[i].errorCode==="2003"?t.rowsToAddToCart()[f].errorMessage(o.t("ns.quickOrder:resources.outOfStockText")):e[i].errorCode==="28360"&&t.rowsToAddToCart()[f].errorMessage(o.t("ns.quickOrder:resources.configurableItemText")))}}}s.sendError("quickOrder",n,!0)};a.create(t.spinnerOptions),t.cart().addItemsToCart(e,i,u,!0)},addToQuickOrder:function(e){var t=this;if(e.numberOfSKUs==1||e.selectedFromDialog){e.orderQuantity=e.orderQuantity||1;var n=t.skuList.indexOf(e.childSKUs[0].repositoryId);if(n>-1){t.rowsToAddToCart()[n].productQuantity(t.rowsToAddToCart()[n].productQuantity()+1),t.rowsToAddToCart()[t.activeSearchBoxIndex()].productQuantity(1),t.activeSearchBoxIndex()!==n?t.rowsToAddToCart()[t.activeSearchBoxIndex()].productDisplay(""):t.addToRow(e);return}t.addToRow(e)}else e.numberOfSKUs>1&&t.handleQuickViewClick(t.popupId,c,e.id)},addToRow:function(t){var n=this;n.skuList()[n.activeSearchBoxIndex()]=t.childSKUs[0].repositoryId,n.rowsToAddToCart()[n.activeSearchBoxIndex()].productName(t.displayName);var r=t.displayName+"    "+t.childSKUs[0].repositoryId;n.rowsToAddToCart()[n.activeSearchBoxIndex()].productDisplay(r),n.rowsToAddToCart()[n.activeSearchBoxIndex()].productQuantity(t.orderQuantity),n.rowsToAddToCart()[n.activeSearchBoxIndex()].catRefId=t.childSKUs[0].repositoryId,e(".modal").modal("hide")},createNewRow:function(){var e=this;e.rowsToAddToCart.push({productDisplay:t.observable(""),productName:t.observable(""),productQuantity:t.observable(1),errorMessage:t.observable(""),catRefId:""}),e.skuList.push(""),e.rowsToAddToCart()[e.rowsToAddToCart().length-1].productQuantity.extend({required:{params:!0,message:e.translate("quantityRequireMsg")},digit:{params:!0,message:e.translate("quantityNumericMsg")},min:{params:1,message:e.translate("quantityGreaterThanMsg",{quantity:0})},max:{params:e.maxQuantityOfItems,message:e.translate("quantitySmallerThanMsg",{quantity:e.maxQuantityOfItems()})}})},lastRowCheck:function(e){var t=this;e==t.rowsToAddToCart().length-1&&t.rowsToAddToCart()[e].productDisplay()!=""&&t.createNewRow()},searchSelected:function(e){var t=this;t.activeSearchBoxIndex(e)},afterBlur:function(e){var t=this;t.rowsToAddToCart()[e].productDisplay()===""&&t.rowsToAddToCart()[e].errorMessage("")},handleFiles:function(e,t){var n=t.target?t.target:t.srcElement,r,i;if(n.files){r=n.files[0];if(r.name.split(".").pop()!=="csv"){s.sendError("quickOrderWidget",e.translate("invalidFileText"),!0);return}e.fileToUpload(r),n.value=""}},getAsText:function(){var e=this,t=new FileReader;t.readAsText(e.fileToUpload()),t.onload=e.loadHandler.bind(this),t.onerror=e.errorHandler.bind(this)},loadHandler:function(e){var t=this,n=e.target.result;t.processData.call(t,n)},processData:function(e){var t=this,n=e.split(/\r\n|\n/),r={},i,o,u;t.skuIds=[],t.lines=[];for(var f=0;f<n.length;f++){var l=n[f].split(";"),c=[];for(var h=0;h<l.length;h++)c.push(l[h]),c[f]!==""&&c[0].split(",")[0]!==""&&(t.skuIds.push(c[0].split(",")[0]),t.lines.push(c))}if(t.lines.length>t.maxNoOfItemsInCSV()){s.sendError("quickOrderWidget",t.translate("maxNoInFileErrorText"),!0);return}t.total=t.skuIds.length,o=t.total-t.MAX_ITEMS_PER_BATCH,o<0&&(o=0),u=t.skuIds.slice(o,t.total),t.initialSKUCall(u),a.create(t.spinnerOptions)},initialSKUCall:function(e){var n=this,r={},o={},f,l;r[u.CATALOG]=n.cart().catalogId(),r[u.SKU_IDS]=e,r[u.PROD_STATE]=!0,r[u.STORE_PRICELISTGROUP_ID]=p.getInstance().selectedPriceListGroup().id,h.request(u.ENDPOINT_PRODUCTS_LIST_SKUS,r,function(r){n.invalidSKUs=n.invalidSKUs.concat(r.deletedSkus);if(n.total>0&&n.total-n.MAX_ITEMS_PER_BATCH>0)n.total=n.total-n.MAX_ITEMS_PER_BATCH,l=n.total-n.MAX_ITEMS_PER_BATCH,l<0&&(l=0),e=n.skuIds.slice(l,n.total),n.initialSKUCall(e);else{for(i=0;i<n.lines.length;i++)n.skuIds[i]!==""&&(o={productName:t.observable(""),productDisplay:t.observable(n.skuIds[i]),catRefId:"",productQuantity:t.observable(n.lines[i][0].split(",")[1]).extend({required:{params:!0,message:n.translate("quantityRequireMsg")},digit:{params:!0,message:n.translate("quantityNumericMsg")},min:{params:1,message:n.translate("quantityGreaterThanMsg",{quantity:0})},max:{params:n.maxQuantityOfItems,message:n.translate("quantitySmallerThanMsg",{quantity:n.maxQuantityOfItems()})}}).isModified(!0),errorMessage:t.observable("")},n.invalidSKUs.indexOf(o.productDisplay())!==-1&&o.errorMessage(n.translate("invalidSKUText")),f=n.rowsToAddToCart().map(function(e){return e.productDisplay()}).indexOf(""),f>-1?n.rowsToAddToCart.splice(f,1,o):n.rowsToAddToCart.push(o));n.lastRowCheck(n.rowsToAddToCart().length-1),a.destroyWithoutDelay(n.spinnerOptions.parent),n.fileToUpload(null)}},function(){s.sendError("quickOrderWidget",n.translate("fileParsingErrorText"),!0),a.destroyWithoutDelay(n.spinnerOptions.parent);return},e)},errorHandler:function(e){e.target.error.name=="NotReadableError"&&alert("Cannot read file !")},clearAll:function(){var t=this;t.beforeAppear(),e(csvFileInput)[0].value="",t.fileToUpload(null)},initializer:function(t){var r=this,i="#"+t;e(i).typeahead({source:r.typeaheadSource,minLength:r.MIN_CHARACTERS,items:r.MAX_RESULTS,fractionalDigits:r.site().selectedPriceListGroup().currency.fractionalDigits,symbol:r.site().selectedPriceListGroup().currency.symbol,matcher:r.typeaheadMatch,sorter:r.typeaheadSort,highlighter:r.typeaheadHighlight,render:r.typeaheadRender,select:r.typeaheadSelect.bind(r),menu:"<ul id='quickOrderDropDown' class='typeahead dropdown-menu' aria-live='polite'></ul>",item:"<li class='typeaheadProduct'><a href='#'>                               <img class = 'typeaheadProductThumbnail visible-md visible-lg img-responsive'/>                           <span class = 'typeaheadProductName'> </span>  <span class = 'typeaheadProductPrice'> </span>  </a></li>"}),e.Topic(n.topicNames.SEARCH_TYPEAHEAD_UPDATED).subscribe(r.typeaheadResults)},typeaheadSource:function(r,i){d=this,this.render=this.options.render||this.render,this.select=this.options.select||this.select,this.noImageThumb=t.observable(p.getInstance().noImageSrc()?p.getInstance().noImageSrc():"/img/no-image.jpg"),this.$menu.css("margin-left",10),this.timer&&clearTimeout(this.timer);var s=function(){d.callback=i,e.Topic(n.topicNames.SEARCH_TYPEAHEAD).publishWith({searchText:d.query,recordsPerPage:5,recordOffSet:0},[{message:"success"}])};this.timer=setTimeout(s,300)},typeaheadResults:function(t){if(d&&d.options&&document.activeElement.className.indexOf("quick-order-query")>-1){var n=[],r=this[0]?this[0]:[],i=this[1]?this[1]:[],s,o;e.each(i,function(t,r){if(r.records[0]){var i=r.records[0],s={};s.id=i.attributes["product.repositoryId"][0],i.attributes["product.displayName"]?s.name=i.attributes["product.displayName"][0]:s.name="",(e(window)[0].innerWidth||e(window).width())>u.VIEWPORT_TABLET_LOWER_WIDTH&&(s.thumb=i.attributes["sku.listingThumbImageURL"]?i.attributes["sku.listingThumbImageURL"]:i.attributes["product.primaryThumbImageURL"]?i.attributes["product.primaryThumbImageURL"][0]:d.noImageThumb(),s.noImageSrc='src="'+d.noImageThumb()+'"');var o=function(e){var t,n,r,i,s;return e.attributes["sku.minActivePrice"][0]?e.attributes["sku.minActivePrice"][0]:(t=e.records[0].attributes["sku.salePrice"]||e.records[0].attributes["sku.salePrice"][0]===0?e.records[0].attributes["sku.salePrice"][0]:e.records[0].attributes["sku.listPrice"][0],t)}(r);s.price=o,s.numRecords=this.numRecords,s.SKUid=this.records[0].attributes["sku.repositoryId"][0],n.push(s)}}),n.length||n.push({id:"NO MATCHES FOUND",name:"",price:"",thumb:""}),d.callback&&typeof d.callback=="function"&&d.callback(n)}},typeaheadMatch:function(e){return!0},typeaheadSort:function(e){return e},typeaheadHighlight:function(e){return e},typeaheadRender:function(t){if(t.length===1&&t[0].id==="NO MATCHES FOUND"){var n=o.t("ns.common:resources.noMatchesFound");return this.$menu.html(e("<li class='typeaheadTop' disabled>").text(n)),this}return t=e(t).map(function(t,n){t=e(d.options.item).attr("data-value",n.name),t.find("a").attr("title",n.name),t.find("a").attr("id",n.id),t.find("a").attr("numRecords",n.numRecords),t.find("a").attr("SKUid",n.SKUid),t.find(".typeaheadProductThumbnail").attr("src",n.thumb),t.find(".typeaheadProductThumbnail").attr("onError",n.noImageSrc),t.find(".typeaheadProductName").html(n.name);var r,i=parseFloat(n.price).toFixed(d.options.fractionalDigits).toString();if(i==="NaN"||i===""||i===null)i=o.t("ns.common:resources.priceUnavailable");return r=d.options.symbol+i,t.find(".typeaheadProductPrice").text(r),t[0]}),t.first().addClass("firstResult"),this.$menu.html(t),this},typeaheadSelect:function(){var e=d.$menu.find(".active"),t=e.children("a").attr("href"),n=e.children("a").attr("id"),r={displayName:e[0].firstChild.attributes.getNamedItem("title").value,id:e.children("a").attr("id"),numberOfSKUs:e[0].firstChild.attributes.getNamedItem("numrecords").value,childSKUs:[{repositoryId:e[0].firstChild.attributes.getNamedItem("skuid").value}]};return this.addToQuickOrder(r),this.isDirty(!0),d.hide()}}})